<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Entropy Control — Predictive Lookahead Guardrails</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --line:rgba(148,163,184,.22); }
    html,body{height:100%}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:#e2e8f0}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:.75rem}
    input,textarea,select{background:#0f172a;border:1px solid #334155;border-radius:.5rem;color:#e2e8f0;padding:.5rem .6rem;width:100%}
    input:focus,textarea:focus,select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.35)}
    .pill{background:#1e293b;border:1px solid #334155;border-radius:999px;padding:.35rem .9rem;font-weight:600;cursor:pointer;transition:.15s background}
    .pill:hover{background:#334155}
    .status{transition:.25s all}
    .s-IDLE{background:#4b5563}.s-GENERATING{background:#2563eb}.s-ANALYZING{background:#7c3aed}.s-BRAKED{background:#dc2626}.s-STOPPED{background:#b45309}.s-ERROR{background:#991b1b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .kpi{font-weight:800}
    .hint{font-size:.85rem;color:#94a3b8}
    .led{width:10px;height:10px;border-radius:9999px;background:#374151;box-shadow:0 0 0 2px rgba(0,0,0,.2) inset}
    .instruction{background:rgba(30,41,59,0.5); border-left: 4px solid #3b82f6; padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.25rem;}
    .clean .advanced-panel{display:none!important}
  </style>
</head>
<body class="min-h-screen">



<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4">

  <div class="lg:col-span-1 flex flex-col gap-4">
    <div class="panel p-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">AI Entropy Control</h1>
      <span id="badge" class="status s-IDLE rounded-full px-3 py-1 text-sm font-semibold">IDLE</span>
    </div>

    <div class="panel p-4">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="rocket"></i> Quick Start</h2>
      <div class="instruction">
        <ol class="list-decimal list-inside text-sm space-y-2">
          <li>Run LM Studio or Ollama.</li>
          <li>Serve this over <b>http://</b> (e.g., <span class="mono">python -m http.server 8000</span>).</li>
          <li>Set <b>API Base</b> and <b>Chat Model</b> (LM Studio defaults below).</li>
          <li>Click <b>Check API</b>. Then use <b>Self-Test</b> or <b>Start</b>.</li>
        </ol>
      </div>
    </div>

    <div class="panel p-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <label class="text-sm flex items-center gap-2">
          <input id="cleanToggle" type="checkbox" class="h-4 w-4"> Clean UI
        </label>
        <span class="text-xs text-slate-400">Hide advanced controls</span>
      </div>
      <div class="flex items-center gap-2">
        <div id="led" class="led"></div><span class="hint">Use <b>http://</b></span>
      </div>
    </div>

    <div class="panel p-4 advanced-panel">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="server"></i> API & Providers</h2>
      <div class="grid grid-cols-1 gap-2">
        <div class="grid grid-cols-2 gap-2 mt-1">
          <div><label for="apiBase" class="text-sm">API Base</label><input id="apiBase" value="http://localhost:1234/v1"/></div>
          <div><label for="apiKey" class="text-sm">API Key</label><input id="apiKey" type="password" placeholder="(optional for local)"/></div>
          <div><label for="modelName" class="text-sm">Chat Model</label><input id="modelName" value="llama3.1:latest" placeholder="Paste model id"/>
<div id="modelsHelper" class="text-xs text-slate-400 mt-1"></div></div>
          <div><label for="lookaheadModel" class="text-sm">Lookahead Model</label><input id="lookaheadModel" placeholder="(defaults to chat)"/></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label for="embBase" class="text-sm">Emb Base</label><input id="embBase" placeholder="http://localhost:1234/v1"/></div>
          <div><label for="embModel" class="text-sm">Emb Model</label><input id="embModel" placeholder="nomic-embed-text"/></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label for="sProvider" class="text-sm">Safety Provider</label><select id="sProvider"><option value="keyword">Keyword</option><option value="llm">LLM</option></select></div>
          <div><label for="nliProvider" class="text-sm">Contradiction Provider</label><select id="nliProvider"><option value="keyword">Keyword</option><option value="llm">LLM</option></select></div>
        </div>
        <div class="mt-2 flex items-end gap-2">
          <button id="btnCheck" class="pill" aria-label="Check API connectivity">Check API</button>
          <button id="saveCfg" class="pill">Save</button>
          <button id="loadCfg" class="pill">Load</button>
        </div>
      </div>
    </div>

    <div class="panel p-4">
      <h2 class="text-lg font-semibold mb-3">Live Lookahead</h2>
      <div class="grid grid-cols-3 gap-2 text-center">
        <div><div class="text-xs hint">APS (speculative)</div><div id="apsLookaheadKpi" class="text-xl kpi">0.00</div></div>
        <div><div class="text-xs hint">Entropy</div><div id="entKpi" class="text-xl kpi">0.00</div></div>
        <div><div class="text-xs hint">Perplexity</div><div id="pplKpi" class="text-xl kpi">0.00</div></div>
      </div>
      <div class="mt-4">
        <div class="text-xs hint mb-1">Speculative Next Sample</div>
        <div id="speculativeText" class="text-sm mono bg-black/20 p-2 rounded-md h-24 overflow-y-auto"></div>
<div class="text-[11px] opacity-70 mt-1" id="lookHealth">Lookahead: —<span id="logprobPill" class="ml-2 px-2 py-0.5 rounded text-[10px]" style="background:#92400e;color:#fff;">logprobs: no</span></div>

<div class="mt-2">
  <button id="toggleBlendDebug" class="text-xs underline opacity-80">Show blend debug</button>
  <div id="blendDebug" class="text-[11px] mt-1 p-2 rounded bg-black/20 border border-slate-700/40 hidden mono"></div>

<div class="mt-2 flex items-center gap-3 text-xs">
  <label class="flex items-center gap-2">
    <input id="ignoreRails" type="checkbox" class="scale-110">
    Ignore rails (debug)
  </label>
  <span id="pegHint" class="opacity-70"></span>
</div>

</div>


<div class="mt-2 grid grid-cols-2 gap-2 text-xs" id="seControls">
  <label class="flex items-center justify-between gap-2">Drafts K
    <input id="seKDrafts" type="number" min="2" max="16" value="6" class="w-20 bg-slate-900/60 border border-slate-700/60 rounded px-2 py-1">
  </label>
  <label class="flex items-center justify-between gap-2">Cluster thr
    <input id="seClusterThr" type="number" min="0.50" max="0.95" step="0.01" value="0.85" class="w-20 bg-slate-900/60 border border-slate-700/60 rounded px-2 py-1">
  </label>
</div>

      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnSelfTest" class="pill" aria-label="Run self-test">Self-Test</button>
        <button id="btnTestEntropy" class="pill" aria-label="Compute entropy/perplexity">Test Entropy</button>
      </div>
    </div>

    <div class="panel p-4 advanced-panel">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="sliders-horizontal"></i> Weights & Thresholds</h2>
      <div class="grid grid-cols-2 gap-3">
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="thetaHi" class="text-xs flex justify-between"><span>θ_hi (High)</span><span class="mono" id="thetaHiVal">70%</span></label>
            <input id="thetaHi" type="range" min="0" max="1" step="0.01" value="0.70" class="w-full accent-red-500">
            <div class="text-[10px] text-red-400 mt-0.5">Emergency brake threshold</div>
          </div>
          <div class="w-2 h-8 rounded" style="background: linear-gradient(to bottom, #ef4444 0%, #fee2e2 100%)"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="thetaLo" class="text-xs flex justify-between"><span>θ_lo (Low)</span><span class="mono" id="thetaLoVal">55%</span></label>
            <input id="thetaLo" type="range" min="0" max="1" step="0.01" value="0.55" class="w-full accent-green-500">
            <div class="text-[10px] text-green-400 mt-0.5">Safe resume threshold</div>
          </div>
          <div class="w-2 h-8 rounded" style="background: linear-gradient(to bottom, #22c55e 0%, #dcfce7 100%)"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="lambda" class="text-xs flex justify-between"><span>λ (EMA)</span><span class="mono" id="lambdaVal">80%</span></label>
            <input id="lambda" type="range" min="0" max="1" step="0.01" value="0.80" class="w-full accent-blue-500">
            <div class="text-[10px] text-blue-400 mt-0.5">Smoothing factor</div>
          </div>
          <div class="w-2 h-8 rounded" style="background: linear-gradient(to bottom, #3b82f6 0%, #dbeafe 100%)"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="thetaCrit" class="text-xs flex justify-between"><span>θ_crit (Critical)</span><span class="mono" id="thetaCritVal">85%</span></label>
            <input id="thetaCrit" type="range" min="0" max="1" step="0.01" value="0.85" class="w-full accent-yellow-500">
            <div class="text-[10px] text-yellow-400 mt-0.5">Critical anomaly level</div>
          </div>
          <div class="w-2 h-8 rounded" style="background: linear-gradient(to bottom, #eab308 0%, #fef9c3 100%)"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wR" class="text-xs flex justify-between"><span>w_R (Repetition)</span><span class="mono" id="wRVal">30%</span></label>
            <input id="wR" type="range" min="0" max="1" step="0.01" value="0.30" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for repetitive content</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wC" class="text-xs flex justify-between"><span>w_C (Contradiction)</span><span class="mono" id="wCVal">20%</span></label>
            <input id="wC" type="range" min="0" max="1" step="0.01" value="0.20" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for logical contradictions</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wN" class="text-xs flex justify-between"><span>w_N (Topic Drift)</span><span class="mono" id="wNVal">20%</span></label>
            <input id="wN" type="range" min="0" max="1" step="0.01" value="0.20" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for topic deviation</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wS" class="text-xs flex justify-between"><span>w_S (Safety)</span><span class="mono" id="wSVal">15%</span></label>
            <input id="wS" type="range" min="0" max="1" step="0.01" value="0.15" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for safety violations</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wJ" class="text-xs flex justify-between"><span>w_J (Injection)</span><span class="mono" id="wJVal">10%</span></label>
            <input id="wJ" type="range" min="0" max="1" step="0.01" value="0.10" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for prompt injection</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wP" class="text-xs flex justify-between"><span>w_P (PII)</span><span class="mono" id="wPVal">5%</span></label>
            <input id="wP" type="range" min="0" max="1" step="0.01" value="0.05" class="w-full accent-purple-500">
            <div class="text-[10px] text-purple-400 mt-0.5">Weight for personal information</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-purple-500 to-purple-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wA" class="text-xs flex justify-between"><span>w_A (APS)</span><span class="mono" id="wAVal">60%</span></label>
            <input id="wA" type="range" min="0" max="1" step="0.01" value="0.60" class="w-full accent-indigo-500">
            <div class="text-[10px] text-indigo-400 mt-0.5">Weight for anomaly score</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-indigo-500 to-indigo-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wV" class="text-xs flex justify-between"><span>w_V (Velocity)</span><span class="mono" id="wVVal">25%</span></label>
            <input id="wV" type="range" min="0" max="1" step="0.01" value="0.25" class="w-full accent-indigo-500">
            <div class="text-[10px] text-indigo-400 mt-0.5">Weight for change velocity</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-indigo-500 to-indigo-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wF" class="text-xs flex justify-between"><span>w_F (Frequency)</span><span class="mono" id="wFVal">15%</span></label>
            <input id="wF" type="range" min="0" max="1" step="0.01" value="0.15" class="w-full accent-indigo-500">
            <div class="text-[10px] text-indigo-400 mt-0.5">Weight for generation frequency</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-indigo-500 to-indigo-100"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex-grow">
            <label for="wSE" class="text-xs flex justify-between"><span>w_SE (Speculative)</span><span class="mono" id="wSEVal">20%</span></label>
            <input id="wSE" type="range" min="0" max="1" step="0.01" value="0.20" class="w-full accent-indigo-500">
            <div class="text-[10px] text-indigo-400 mt-0.5">Weight for speculative execution</div>
          </div>
          <div class="w-2 h-8 rounded bg-gradient-to-b from-indigo-500 to-indigo-100"></div>
        </div>

      </div>
      <section class="panel mt-3 p-3" style="border:1px solid rgba(148,163,184,.2);border-radius:12px">
        <h3 class="text-sm font-semibold mb-2">Predictive Upgrades</h3>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2"><input id="chgCusum" type="checkbox"/> CUSUM ramp detector</label>
          <label class="flex items-center gap-2"><input id="entropyGate" type="checkbox"/> Entropy/Perplexity gate</label>
          <label class="flex items-center gap-2"><input id="lookaheadOn" type="checkbox" checked/> Speculative lookahead</label>
          <div><label for="cusumK" class="text-xs">CUSUM k</label><input id="cusumK" type="number" step="0.01" value="0.05"></div>
          <div><label for="cusumH" class="text-xs">CUSUM h</label><input id="cusumH" type="number" step="0.01" value="0.5"></div>
          <div><label for="entThresh" class="text-xs">Entropy ≤</label><input id="entThresh" value="1.2"></div>
          <div><label for="pplThresh" class="text-xs">Perplexity ≤</label><input id="pplThresh" value="2.5"></div>
          <div><label for="lookaheadN" class="text-xs">Lookahead tokens</label><input id="lookaheadN" type="number" min="5" max="128" step="1" value="48"></div>
        </div>
      </section>
    
    <div class="panel p-4 advanced-panel">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="activity"></i> ALC / ALCad (Control Loop)</h2>
      <div class="grid grid-cols-2 gap-3">
        <div><label for="ntail" class="text-xs">N_tail (tokens withheld)</label><input id="ntail" type="number" min="0" max="50" step="1" value="10"></div>
        <div><label for="kResume" class="text-xs">K_RESUME (frames &lt;= θ_lo)</label><input id="kResume" type="number" min="1" max="100" step="1" value="12"></div>
        <div><label for="cooldownMs" class="text-xs">Cooldown τ (ms)</label><input id="cooldownMs" type="number" min="0" step="100" value="2000"></div>
        <div><label for="cadBase" class="text-xs">cad_base (ms)</label><input id="cadBase" type="number" min="10" step="5" value="400"></div>
        <div><label for="cadMin" class="text-xs">cad_min (ms)</label><input id="cadMin" type="number" min="10" step="5" value="120"></div>
        <div><label for="cadMax" class="text-xs">cad_max (ms)</label><input id="cadMax" type="number" min="50" step="5" value="1200"></div>
        <div><label for="alphaAPS" class="text-xs">α (APS influence)</label><input id="alphaAPS" type="number" step="0.01" value="200"></div>
        <div><label for="betaVel" class="text-xs">β (velocity influence)</label><input id="betaVel" type="number" step="0.01" value="50"></div>
        <div><label for="gammaStreak" class="text-xs">γ (stability streak)</label><input id="gammaStreak" type="number" step="0.01" value="10"></div>
        <div><label for="hysteresis" class="text-xs">Hysteresis Δ</label><input id="hysteresis" type="number" step="0.01" value="0.03"></div>
      </div>
      <p class="hint mt-2">ALCad adjusts <em>lookahead frequency</em> and <em>horizon</em> using APS and its velocity. ALC enforces brake/cooldown/resume &amp; tail-buffer non‑leakage.</p>
    </div>
</div>
  </div>

  <div class="lg:col-span-2 flex flex-col gap-4">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="panel p-4 text-center">
        <p class="text-sm text-slate-400">System Status</p>
        <p id="status" class="status s-IDLE rounded-full py-1 mt-1 text-sm font-bold">IDLE</p>
      </div>
      <div class="panel p-4 text-center">
        <p class="text-sm text-slate-400">High Threshold (θ_hi)</p>
        <p id="thetaHiText" class="text-2xl font-bold text-red-400 mt-1">0.70</p>
      </div>
      <div class="panel p-4 text-center">
        <p class="text-sm text-slate-400">Low Threshold (θ_lo)</p>
        <p id="thetaLoText" class="text-2xl font-bold text-green-400 mt-1">0.55</p>
      </div>
      <div class="panel p-4 text-center">
        <p class="text-sm text-slate-400">APS* (Blended)</p>
        <p id="apsBlend" class="text-2xl font-bold mt-1">0.000</p>
      </div>
      <div class="panel p-4 text-center">
        <p class="text-sm text-slate-400">Critical (θ_crit)</p>
        <p id="thetaCritText" class="text-2xl font-bold text-yellow-300 mt-1">0.85</p>
      </div>
    </div>

    <div class="panel p-4">
      <h2 class="text-lg font-semibold mb-2">Live Anomaly Scores</h2>
      <canvas id="chart" style="height:260px"></canvas>
    </div>

    <div class="panel p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="terminal"></i> Prompt & Controls</h2>
      <textarea id="prompt" class="mono flex-grow" rows="6" placeholder="Write a short story that contradicts itself."></textarea>
      <div class="grid grid-cols-4 gap-2 mt-2">
        <button id="startBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-md py-2" aria-label="Start AEC pipeline">Start</button>
        <button id="stopBtn" class="bg-red-600 hover:bg-red-700 text-white rounded-md py-2" disabled aria-label="Stop AEC pipeline">Stop</button>
        <button id="resetBtn" class="bg-gray-600 hover:bg-gray-700 text-white rounded-md py-2" aria-label="Reset session">Reset</button>
        <button id="exportCsv" class="bg-gray-700 hover:bg-gray-600 text-white rounded-md py-2" aria-label="Export CSV metrics">CSV</button>
      </div>
    </div>

    <div class="panel p-4">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="info"></i> Explanations</h2>
      <div id="explanations" class="text-sm" style="min-height: 50px;"></div>
    </div>

    <div class="panel p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2"><i data-lucide="cast"></i> Live Output</h2>
      <div id="output" class="bg-black/40 p-3 rounded-md flex-grow overflow-y-auto text-sm mono whitespace-pre-wrap" style="min-height:200px"></div>
      <div class="mt-2 text-xs hint">Reasons: <span id="reasons" class="mono"></span></div>
    </div>
  </div>
</div>

<script id="worker-code" type="javascript/worker">
let CFG = {
  apiBase:'', apiKey:'', modelName:'', lookaheadModel:'',
  embBase:'', embModel:'', sProvider:'keyword', nliProvider:'keyword', nliModel:'',
  policy:{}
};

// Math & helpers
const dot=(a,b)=>a.reduce((s,x,i)=>s+x*b[i],0);
const mag=a=>Math.sqrt(a.reduce((s,x)=>s+x*x,0));
const cos=(a,b)=>{ const d=mag(a)*mag(b); return d?dot(a,b)/d:0; };
function fnv1a(str){ let h=0x811c9dc5>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,0x01000193)>>>0;} return h>>>0; }
function mulberry32(a){ return function(){ a|=0; a=(a+0x6D2B79F5)|0; let t=Math.imul(a^a>>>15,1|a); t^=t+Math.imul(t^t>>>7,61|t); return ((t^t>>>14)>>>0)/4294967296; }; }
function shimEmbed(text, dim=192, bags=3){ const norm=(text||'').toLowerCase().replace(/\s+/g,' ').trim(); const seed=fnv1a(norm)||0xDEADBEEF; const rng=mulberry32(seed); const v=new Float32Array(dim); for(let b=0;b<bags;b++){ for(let i=0;i<dim;i++){ v[i]+=rng()*2-1; } } let s=0; for(const x of v) s+=x*x; const inv=1/Math.sqrt(s||1); for(let i=0;i<v.length;i++) v[i]*=inv; return [...v]; }
async function getEmbedding(text){
  const base=(CFG.embBase||'').replace(/\/$/,''); if(base && CFG.embModel){
    try{ const res=await fetch(base+'/embeddings',{method:'POST',headers:{'Content-Type':'application/json', ...(CFG.apiKey?{'Authorization':'Bearer '+CFG.apiKey}:{})},body:JSON.stringify({input:text,model:CFG.embModel})});
      const js=await res.json(); const arr=js?.data?.[0]?.embedding; if(Array.isArray(arr)){ const f=new Float32Array(arr.length); for(let i=0;i<arr.length;i++) f[i]=arr[i]; let s=0; for(const x of f) s+=x*x; const inv=1/Math.sqrt(s||1); for(let i=0;i<f.length;i++) f[i]*=inv; return [...f]; }
    }catch(e){}
    try{ const res2=await fetch(base.replace(/\/v1$/,'')+'/api/embeddings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:CFG.embModel,input:text})});
      const j2=await res2.json(); const arr=j2?.embedding; if(Array.isArray(arr)){ const f=new Float32Array(arr.length); for(let i=0;i<arr.length;i++) f[i]=arr[i]; let s=0; for(const x of f) s+=x*x; const inv=1/Math.sqrt(s||1); for(let i=0;i<f.length;i++) f[i]*=inv; return [...f]; }
    }catch(e){}
  }
  return shimEmbed(text);
}

// Rails & detectors
const injPatterns=[/\bignore (all|the) (previous|prior) (instructions|rules)\b/i, /\bdisregard.*policy\b/i, /\bjailbreak\b/i, /\bbypass\b/i, /\bdeveloper mode\b/i, /\breveal (the )?(system|hidden) prompt\b/i, /\bprompt injection\b/i];
const piiRegex={ email:/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig, phone:/(\+?\d{1,2}[\s-]?)?(\(?\d{3}\)?[\s-]?)?\d{3}[\s-]?\d{4}/g, ssn:/\b\d{3}-\d{2}-\d{4}\b/g, cc:/\b(?:\d[ -]*?){13,16}\b/g, api:/(sk-|AIza|ghp_|gho_|xox[pbar]|eyJ[A-Za-z0-9_\-]{10,})[A-Za-z0-9_\-]{10,}/g };
const safetyBuckets={ selfharm:/\b(self[-\s]?harm|suicide|kill myself|cutting)\b/i, violence:/\b(kill|murder|assassinate|harm (someone|people))\b/i, weapons:/\b(bomb|explosive|thermite|grenade|improvised explosive)\b/i, sexual:/\b(minor|underage|child porn|cp)\b/i, hate:/\b(hate.*(race|religion|gay|muslim|jew|black|white|asian|lgbtq)|genocide)\b/i };

function ngramRepeat(txt){ const words=(txt||'').toLowerCase().split(/\s+/).filter(Boolean); if(words.length<16) return 0; const map=new Map(); let maxF=0; for(let i=0;i<words.length-9;i++){ const key=words.slice(i,i+10).join(' '); const n=(map.get(key)||0)+1; map.set(key,n); if(n>maxF)maxF=n; } return Math.max(0, Math.min(1,(maxF-1)/5)); }
function emaVec(prev,cur,a=0.1){ if(!prev) return cur.slice(); return prev.map((v,i)=>(1-a)*v + a*cur[i]); }
let W={ anchorVec:null, topicVec:null, windowText:'', factLedger:[] };

async function scoreR(newText){ const prev=W.windowText; W.windowText=(prev+' '+newText).slice(-1400); const a=await getEmbedding(prev.slice(-600)); const b=await getEmbedding(newText.slice(-600)); const sim=cos(a,b); const rep=ngramRepeat(W.windowText); return Math.min(1, 0.7*sim + 0.3*rep); }
async function scoreN(newText,anchor){ if(!W.anchorVec){ W.anchorVec=await getEmbedding(anchor||''); W.topicVec=W.anchorVec.slice(); } const cur=await getEmbedding(newText); W.topicVec=emaVec(W.topicVec,cur,0.1); const sim=cos(W.anchorVec,W.topicVec); return 1-Math.max(0,Math.min(1,sim)); }
async function scoreC(latest, full){ const pos=/\b(happy|agree|true|yes|correct)\b/i.test(latest); const neg=/\b(sad|angry|false|no|not|incorrect)\b/i.test(latest); const score=(pos&&neg)?1:(neg?0.6:0.1); W.factLedger.push(latest); if(W.factLedger.length>5) W.factLedger.shift(); return score; }

async function railInjection(latest, full){ const hits=injPatterns.filter(p=>p.test(latest)); const score=Math.min(1, hits.length? 0.7 + 0.1*hits.length : /system prompt|policy/i.test(full)?0.4:0.1); return {score, reasons: hits.map(h=>'inj:'+h.source)}; }
async function railPII(latest){ let hits=[]; let count=0; for(const [k,rx] of Object.entries(piiRegex)){ const m = latest.match(rx); if(m && m.length){ hits.push(`${k}:${m.length}`); count += Math.min(5,m.length); } } const score = Math.min(1, count/5); return {score, reasons:hits}; }
async function railSafety(latest, full){ if((CFG.sProvider||'keyword')==='keyword'){ let maxScore=0; let reasons=[]; for(const [k,rx] of Object.entries(safetyBuckets)){ if(rx.test(latest)){ maxScore=Math.max(maxScore,0.85); reasons.push('safety:'+k); } } const deny=CFG?.policy?.deny_phrases||[]; for(const phrase of deny){ if(phrase && latest.toLowerCase().includes(String(phrase).toLowerCase())){ maxScore=Math.max(maxScore,0.95); reasons.push(`deny:"${phrase}"`);} } return {score: Math.max(0.1, maxScore||0.1), reasons}; } else { return {score:0.2, reasons:[]}; } }

// Entropy & Perplexity
function shannonEntropyFromLogprobs(logprobs){ if(!Array.isArray(logprobs)||!logprobs.length) return 0; let ps=logprobs.map(lp=>Math.exp(lp)); let sum=ps.reduce((a,b)=>a+b,0)||1; ps=ps.map(p=>p/sum); let H=0; for(const p of ps){ if(p>0) H -= p*Math.log(p+1e-12); } return H; }
function perplexityFromEntropy(H){ return Math.exp(H||0); }

// Lookahead
async function providerDraft(nextN, context){
  const base=(CFG.apiBase||'').replace(/\/$/,''); if(!base) return {text:'', logprobs:[]};
  try{
    const res = await fetch(base+'/chat/completions',{
      method:'POST', headers:{'Content-Type':'application/json', ...(CFG.apiKey?{'Authorization':'Bearer '+CFG.apiKey}:{})},
      body: JSON.stringify({ model:(CFG.lookaheadModel||CFG.modelName||'auto'), temperature:0.2, max_tokens: Math.min(128, Math.max(5,nextN|0)), logprobs:true, top_logprobs:5, messages:[{role:'user',content:context.slice(-4000)}] })
    });
    const js = await res.json();
    const text = js?.choices?.[0]?.message?.content || js?.choices?.[0]?.text || '';
    const lps = (js?.choices?.[0]?.logprobs?.content||[]).map(x=>x?.logprob).filter(x=>typeof x==='number');
    return {text, logprobs:lps};
  }catch(e){}
  try{
    const res2 = await fetch(base.replace(/\/v1$/,'')+'/api/generate',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model: CFG.modelName||'llama3', prompt: context.slice(-4000), options:{temperature:0.2, num_predict: nextN|0}})
    });
    const js2 = await res2.json();
    const text = js2?.response || '';
    return {text, logprobs:[]};
  }catch(e){}
  return {text:'', logprobs:[]};
}

// === Semantic Entropy (SE) Helpers ===
function __se_l2(v){ let s=0; for(const x of v) s+=x*x; s=Math.sqrt(s||1e-9); return v.map(x=>x/s); }
function __se_cos(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }
function __se_cluster(vecs, thr){
  const clusters=[];
  for(let i=0;i<vecs.length;i++){
    const v=vecs[i]; let placed=false;
    for(const c of clusters){
      if(__se_cos(v, c.centroid) >= thr){
        c.idxs.push(i);
        for(let k=0;k<c.centroid.length;k++){
          c.centroid[k]=(c.centroid[k]*(c.idxs.length-1)+v[k])/c.idxs.length;
        }
        c.centroid = __se_l2(c.centroid);
        placed=true; break;
      }
    }
    if(!placed) clusters.push({ idxs:[i], centroid: v.slice(0) });
  }
  return clusters;
}
function __se_entropy(ps){ let H=0; for(const p of ps){ if(p>0) H += -p*Math.log(p); } return H; }
function __se_norm(H,m){ return (m<=1)?0 : H/Math.log(m); }

async function __se_drafts(K, context, nextN){
  const out=[];
  for(let i=0;i<K;i++){
    const r = await providerDraft(nextN||64, context);
    out.push((r.text||'').trim());
  }
  return out;
}

async function __se_forContext(context, K, thr){
  const drafts = await __se_drafts(K||6, context||'', 64);
  const vecs = [];
  for(const d of drafts){
    const e = await getEmbedding(d);
    vecs.push(__se_l2(e));
  }
  const clusters = __se_cluster(vecs, thr||0.85);
  const probs = clusters.map(c => c.idxs.length / Math.max(1, drafts.length));
  const H = __se_entropy(probs);
  const se = __se_norm(H, Math.max(1, clusters.length));
  return { se, H, m: clusters.length, drafts };
}

onmessage = async (e) => {
  const {type, payload} = e.data||{};
  if(type==='CONFIG'){ CFG={...CFG, ...(payload||{})}; return; }
  if(type==='RESET'){ W={ anchorVec:null, topicVec:null, windowText:'', factLedger:[] }; return; }
  if(type==='LOOKAHEAD'){
    const nextN = Number.isFinite(payload.nextN)? payload.nextN : 48;
    const context = payload.context||'';
    const r = await providerDraft(nextN, context);
    const [rpt, nli, coh, saf, inj, pii] = await Promise.all([
      scoreR(r.text||''), scoreN(r.text||'', context||''), scoreC(r.text||'', context||''),
      railSafety(r.text||'', context||''), railInjection(r.text||'', context||''), railPII(r.text||'')
    ]);
    const H = shannonEntropyFromLogprobs(r.logprobs||[]);
    const ppl = perplexityFromEntropy(H);
    postMessage({ type:'DRAFT_METRICS', payload:{ ap:Math.max(rpt,nli,coh,saf.score,inj.score,pii.score), ent:H, ppl, text:r.text, reasons:[...saf.reasons,...inj.reasons,...pii.reasons] } });
    return;
  }
  if(type==='TICK'){
    const fullText = payload.fullText||'';
    const delta = payload.delta||'';
    const anchor = payload.anchor||'';
    const sentences = fullText.match(/[^.!?]+[.!?]+/g) || [];
    const lastSentence = sentences.length ? sentences[sentences.length - 1] : delta;
    const [r,n,c,saf,inj,pii] = await Promise.all([
      scoreR(delta||''), scoreN(delta||'', anchor||''), scoreC(lastSentence, fullText),
      railSafety(delta||'', fullText), railInjection(delta||'', fullText), railPII(delta||'')
    ]);
    postMessage({ R:r, N:n, C:c, S:saf.score, J:inj.score, P:pii.score, reasons:[...saf.reasons, ...inj.reasons, ...pii.reasons] });
    return;
  }
  // SE message hook (fixed)
  if (type === 'SE_FOR_CONTEXT') {
    try {
      const res = await __se_forContext(payload?.context || '', payload?.K || 6, payload?.thr || 0.85);
      postMessage({ type: 'DRAFTS_SE', payload: res });
    } catch (err) {
      postMessage({ type: 'DRAFTS_SE', error: String(err && err.message || err) });
    }
    return;
  }
};
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // Setup slider value displays
  const sliders = ['thetaHi', 'thetaLo', 'lambda', 'thetaCrit', 'wR', 'wC', 'wN', 'wS', 'wJ', 'wP', 'wA', 'wV', 'wF', 'wSE'];
  sliders.forEach(id => {
    const slider = document.getElementById(id);
    const valueDisplay = document.getElementById(id + 'Val');
    if (slider && valueDisplay) {
      const updateValue = () => valueDisplay.textContent = Math.round(slider.value * 100) + '%';
      slider.addEventListener('input', updateValue);
      updateValue();
    }
  });
  const $=id=>document.getElementById(id);
  lucide.createIcons();

  // Clean UI toggle
  const cleanKey='sohvie_shield_clean_ui';
  if(localStorage.getItem(cleanKey)===null){ localStorage.setItem(cleanKey,'1'); }
  document.documentElement.classList.toggle('clean', localStorage.getItem(cleanKey)==='1');
  $('cleanToggle').checked = document.documentElement.classList.contains('clean');
  $('cleanToggle').addEventListener('change',()=>{ document.documentElement.classList.toggle('clean', $('cleanToggle').checked); localStorage.setItem(cleanKey, $('cleanToggle').checked?'1':'0'); });

  // LED http hint
  setTimeout(()=>{ $('led').style.background = (location.protocol==='http:')? '#10b981' : '#374151'; }, 600);

  // Worker
  let worker;
  try{
    const code=$('worker-code').textContent;
    worker=new Worker(URL.createObjectURL(new Blob([code],{type:'text/javascript'})));
    window.worker = worker; // <-- expose globally for SE wiring
  }catch(e){
    alert('Worker failed. Serve over http://'); return;
  }
  function postWorker(type,payload){ worker && worker.postMessage({type,payload}); }

  // Config
  function getCfg(){ return {
    apiBase:$('apiBase').value.trim(), apiKey:$('apiKey').value.trim(),
    modelName:$('modelName').value.trim(), lookaheadModel:$('lookaheadModel').value.trim(),
    embBase:$('embBase').value.trim(), embModel:$('embModel').value.trim(),
    sProvider:($('sProvider')?.value||'keyword'), nliProvider:($('nliProvider')?.value||'keyword'), nliModel:($('nliModel')?.value||'')
  };}
  function sendCfg(){ postWorker('CONFIG', getCfg()); }
  sendCfg();

  const badge=$('badge'), statusBox=$('status'), output=$('output'), reasons=$('reasons');
  const entK=$('entKpi'), pplK=$('pplKpi'), apsLook=$('apsLookaheadKpi'), spec=$('speculativeText'), apsBlend=$('apsBlend');
  const thetaHi=$('thetaHi'), thetaLo=$('thetaLo'), thetaCrit=$('thetaCrit');
  const thetaHiText=$('thetaHiText'), thetaLoText=$('thetaLoText'), thetaCritText=$('thetaCritText');

  // Save/Load config
  $('saveCfg').addEventListener('click',()=>{ localStorage.setItem('sohvie_cfg', JSON.stringify(getCfg())); });
  $('loadCfg').addEventListener('click',()=>{ try{ const c=JSON.parse(localStorage.getItem('sohvie_cfg')||'{}'); for(const [k,v] of Object.entries(c)){ if($(k)) $(k).value=v; } sendCfg(); }catch(e){} });

  // Check API
  $('btnCheck').addEventListener('click', async ()=>{
    badge.textContent='ANALYZING'; badge.className='status s-ANALYZING rounded-full px-3 py-1 text-sm font-semibold';
    try{
      const res = await fetch($('apiBase').value.replace(/\/$/,'')+'/models', { headers:{'Authorization': getCfg().apiKey?('Bearer '+getCfg().apiKey):''} });
      const ok=res.ok; badge.textContent = ok?'IDLE':'ERROR'; badge.className='status '+(ok?'s-IDLE':'s-ERROR')+' rounded-full px-3 py-1 text-sm font-semibold';
      if(!ok){ output.textContent='Model list failed: '+(await res.text()).slice(0,300); }
    }catch(e){ badge.textContent='ERROR'; badge.className='status s-ERROR rounded-full px-3 py-1 text-sm font-semibold'; output.textContent='Check failed: '+e.message; }
  });

  // Self-Test / Entropy test
  $('btnSelfTest').addEventListener('click', ()=>{
    sendCfg();
    const ctx='Say a short friendly sentence. Then say the opposite.';
    postWorker('LOOKAHEAD', { nextN: 48, context: ctx });
  });
  $('btnTestEntropy').addEventListener('click', ()=>{
    sendCfg();
    const ctx = (window.S?.fullText || '') + ($('prompt')?.value || '');
    postWorker('LOOKAHEAD', { nextN: 48, context: ctx });
  });

  // Chart
  const chartCtx=document.getElementById('chart').getContext('2d');
  const chart=new Chart(chartCtx,{ type:'line', data:{labels:[], datasets:[
    {label:'APS*',data:[],tension:0.1,pointRadius:0},
    {label:'R',data:[],tension:0.1,pointRadius:0},
    {label:'C',data:[],tension:0.1,pointRadius:0},
    {label:'N',data:[],tension:0.1,pointRadius:0},
    {label:'S',data:[],tension:0.1,pointRadius:0},
    {label:'J',data:[],tension:0.1,pointRadius:0},
    {label:'P',data:[],tension:0.1,pointRadius:0}
  ]}, options:{ responsive:true, animation:false, scales:{ y:{ beginAtZero:true, max:1 } } }});

  function pushPoint(ap,r,c,n,s,j,p){
    chart.data.labels.push('');
    chart.data.datasets[0].data.push(ap);
    chart.data.datasets[1].data.push(r);
    chart.data.datasets[2].data.push(c);
    chart.data.datasets[3].data.push(n);
    chart.data.datasets[4].data.push(s);
    chart.data.datasets[5].data.push(j);
    chart.data.datasets[6].data.push(p);
    if(chart.data.labels.length>200){ for(const ds of chart.data.datasets){ ds.data.shift(); } chart.data.labels.shift(); }
    chart.update();
  }

  // Simple one-shot generation + metric tick on full response
  let S={ running:false, stopFlag:false, anchor:'', fullText:'', emaAPS:0 };
  function blendAPS(w){
  const R = w.R||0, N = w.N||0, C = w.C||0;
  const wA = parseFloat(document.getElementById('wA').value || '0.6');
  const wV = parseFloat(document.getElementById('wV').value || '0.25');
  const wF = parseFloat(document.getElementById('wF').value || '0.15');
  const wSE = parseFloat(document.getElementById('wSE')?.value || '0.20');
  const se = (w.SE!=null ? w.SE : (window.S && typeof S.se==='number' ? S.se : 0));
  const sum = Math.max(0, Math.min(1, wA*R + wV*N + wF*C + wSE*se));
  const ignore = !!document.getElementById('ignoreRails')?.checked;
  const base = ignore ? sum : Math.max(sum, w.S||0, w.J||0, w.P||0);
  return base;
}

  worker.onmessage = (e)=>{
    // AEC hook: integrate APS into EMA/ALC

    const d=e.data||{};
    
    if(d && d.type==='DRAFTS_SE' && d.payload && typeof d.payload.se === 'number'){
      S.se = Math.max(0, Math.min(1, d.payload.se));
      const kpi = document.getElementById('seKpi');
      if(kpi) kpi.textContent = S.se.toFixed(3);
      return;
    }
if(d.type==='DRAFT_METRICS'){
      const ap = Math.max(0, Math.min(1, Number(d.payload?.ap)||0));
      const ent = Math.max(0, Number(d.payload?.ent)||0);
      const ppl = Math.max(0, Number(d.payload?.ppl)||0);
      $('apsLookaheadKpi').textContent = ap.toFixed(2);
      $('entKpi').textContent = ent.toFixed(2);
      $('pplKpi').textContent = ppl.toFixed(2);
      if(d.payload?.text){ $('speculativeText').textContent = d.payload.text; }
      if(Array.isArray(d.payload?.reasons)){ $('reasons').textContent = d.payload.reasons.join(', '); }
      window.__lastLookTs = Date.now();
      const m = (typeof d.payload?.m === 'number') ? d.payload.m : (Array.isArray(d.payload?.clusters)? d.payload.clusters.length : undefined);
      const hasLogprobs = !!d.payload?.hasLogprobs || (typeof d.payload?.ent === 'number');
      const k = (typeof d.payload?.K === 'number') ? d.payload.K : undefined;
      const parts = [];
      if(typeof m !== 'undefined') parts.push(`m=${m}`);
      if(typeof k !== 'undefined') parts.push(`K=${k}`);
      parts.push(`logprobs=${hasLogprobs?'yes':'no'}`);
      document.getElementById('lookHealth').textContent = 'Lookahead: ' + parts.join(' • ');
      return;
    }
        const w={
      R: Math.max(0, Math.min(1, d.R||0)),
      N: Math.max(0, Math.min(1, d.N||0)),
      C: Math.max(0, Math.min(1, d.C||0)),
      S: Math.max(0, Math.min(1, d.S||0)),
      J: Math.max(0, Math.min(1, d.J||0)),
      P: Math.max(0, Math.min(1, d.P||0))
    };
        const baseAPS=blendAPS(w);
    updateEMA(baseAPS);
    // Peg hint: detect if APS equals a rail for 3 consecutive ticks
    try{
      const ph = document.getElementById('pegHint');
      if(ph && !document.getElementById('ignoreRails')?.checked){
        const eqS = Math.abs(baseAPS - w.S) < 1e-6;
        const eqJ = Math.abs(baseAPS - w.J) < 1e-6;
        const eqP = Math.abs(baseAPS - w.P) < 1e-6;
        const tag = eqS ? 'S' : (eqJ ? 'J' : (eqP ? 'P' : ''));
        if(!window.__peg){ window.__peg={tag:'',count:0}; }
        if(tag){
          if(window.__peg.tag===tag){ window.__peg.count++; } else { window.__peg={tag, count:1}; }
        } else { window.__peg={tag:'',count:0}; }
        if(window.__peg.count>=3 && tag){ ph.textContent = `pegged by ${tag}`; }
        else if(!tag){ ph.textContent=''; }
      }
    }catch(_){}
    if(enforceALC(baseAPS)) { /* braked: discard tail */ AEC.tail=[]; applyTailRuleDisplay(); return; }
    pushPoint(baseAPS,w.R,w.C,w.N,w.S,w.J,w.P);
if(enforceALC(baseAPS)) { /* braked: discard tail */ AEC.tail=[]; applyTailRuleDisplay(); return; }
    pushPoint(baseAPS,w.R,w.C,w.N,w.S,w.J,w.P);
    $('reasons').textContent = (d.reasons||[]).join(', ');
    const hi=parseFloat($('thetaHi').value||'0.7'), lo=parseFloat($('thetaLo').value||'0.55'), crit=parseFloat($('thetaCrit').value||'0.85');
    $('thetaHiText').textContent = hi.toFixed(2);
    $('thetaLoText').textContent = lo.toFixed(2);
    $('thetaCritText').textContent = crit.toFixed(2);
    if(baseAPS>=crit){ $('badge').textContent='BRAKED'; $('badge').className='status s-BRAKED rounded-full px-3 py-1 text-sm font-semibold'; $('status').className='status s-BRAKED rounded-full py-1 mt-1 text-sm font-bold'; $('status').textContent='BRAKED'; }
    else if(baseAPS>=hi){ $('badge').textContent='ANALYZING'; $('badge').className='status s-ANALYZING rounded-full px-3 py-1 text-sm font-semibold'; $('status').className='status s-ANALYZING rounded-full py-1 mt-1 text-sm font-bold'; $('status').textContent='ANALYZING'; }
    else if(baseAPS<=lo){ $('badge').textContent='IDLE'; $('badge').className='status s-IDLE rounded-full px-3 py-1 text-sm font-semibold'; $('status').className='status s-IDLE rounded-full py-1 mt-1 text-sm font-bold'; $('status').textContent='IDLE'; }
  };


  // --- AEC State & Tail Buffer Helpers ---
  const AEC = {
    state: 'IDLE', // IDLE | GENERATING | ANALYZING | BRAKED | RESUME_WAIT
    emaAPS: 0,
    lastAPS: 0,
    velocity: 0,
    stabilityStreak: 0,
    kResumeCtr: 0,
    cooldownUntil: 0,
    lookTimer: null,
    streamTimer: null,
    tokenIdx: 0,
    tokens: [],
    emitted: [],
    tail: [],
    draftsEntropy: 0,
  };

  function now(){ return Date.now(); }

  function setState(s){
    AEC.state = s;
    const badge = document.getElementById('badge');
    const status = document.getElementById('status');
    if(s==='BRAKED'){ badge.textContent='BRAKED'; badge.className='status s-BRAKED rounded-full px-3 py-1 text-sm font-semibold'; status.className='status s-BRAKED rounded-full py-1 mt-1 text-sm font-bold'; status.textContent='BRAKED'; }
    else if(s==='ANALYZING'){ badge.textContent='ANALYZING'; badge.className='status s-ANALYZING rounded-full px-3 py-1 text-sm font-semibold'; status.className='status s-ANALYZING rounded-full py-1 mt-1 text-sm font-bold'; status.textContent='ANALYZING'; }
    else if(s==='GENERATING'){ badge.textContent='GENERATING'; badge.className='status s-GENERATING rounded-full px-3 py-1 text-sm font-semibold'; status.className='status s-GENERATING rounded-full py-1 mt-1 text-sm font-bold'; status.textContent='GENERATING'; }
    else { badge.textContent='IDLE'; badge.className='status s-IDLE rounded-full px-3 py-1 text-sm font-semibold'; status.className='status s-IDLE rounded-full py-1 mt-1 text-sm font-bold'; status.textContent='IDLE'; }
  }

  function currentThresholds(){
    return {
      hi: parseFloat(document.getElementById('thetaHi').value||'0.7'),
      lo: parseFloat(document.getElementById('thetaLo').value||'0.55'),
      crit: parseFloat(document.getElementById('thetaCrit').value||'0.85'),
      hysteresis: parseFloat(document.getElementById('hysteresis').value||'0.03'),
    };
  }

  function cadParams(){
    return {
      base: parseFloat(document.getElementById('cadBase').value||'400'),
      min: parseFloat(document.getElementById('cadMin').value||'120'),
      max: parseFloat(document.getElementById('cadMax').value||'1200'),
      alpha: parseFloat(document.getElementById('alphaAPS').value||'200'),
      beta: parseFloat(document.getElementById('betaVel').value||'50'),
      gamma: parseFloat(document.getElementById('gammaStreak').value||'10'),
    };
  }

  function tailParams(){
    return {
      N: parseInt(document.getElementById('ntail').value||'10',10),
      K: parseInt(document.getElementById('kResume').value||'12',10),
      tau: parseInt(document.getElementById('cooldownMs').value||'2000',10),
    };
  }

  function updateEMA(baseAPS){
    const lam=parseFloat(document.getElementById('lambda').value||'0.8');
    AEC.emaAPS = (1-lam)*baseAPS + lam*(AEC.emaAPS||baseAPS);
    document.getElementById('apsBlend').textContent = AEC.emaAPS.toFixed(3);
    AEC.velocity = AEC.emaAPS - (AEC.lastAPS||AEC.emaAPS);
    AEC.lastAPS = AEC.emaAPS;
    const th = currentThresholds();
    if(AEC.emaAPS < th.lo) AEC.stabilityStreak++; else AEC.stabilityStreak = 0;
  }

  function computeCadence(){
    const {base,min,max,alpha,beta,gamma} = cadParams();
    const cadence = Math.max(min, Math.min(max, base - alpha*(AEC.emaAPS||0) - beta*(AEC.velocity||0) + gamma*(AEC.stabilityStreak||0)));
    return cadence;
  }

  function scheduleLookahead(ctx){
    if(AEC.lookTimer) clearTimeout(AEC.lookTimer);
    const delay = computeCadence();
    AEC.lookTimer = setTimeout(()=>{
      try{
        postWorker('LOOKAHEAD', { nextN: parseInt(document.getElementById('lookaheadN').value||'48',10), context: ctx });
      }catch(e){}
      // reschedule
      scheduleLookahead(ctx);
    }, delay);
  }

  function applyTailRuleDisplay(){
    const N = tailParams().N;
    const outEl = document.getElementById('output');
    // Show emitted minus tail
    const safeLen = Math.max(0, AEC.emitted.length - N);
    const visible = AEC.emitted.slice(0, safeLen).join('');
    outEl.textContent = visible;
  }

  function enforceALC(baseAPS){
    const th=currentThresholds(); const {tau, K}=tailParams();
    if(baseAPS>=th.crit){
      setState('BRAKED'); AEC.cooldownUntil = now() + tau;
      AEC.kResumeCtr = 0;
      return true;
    } else if(baseAPS>=th.hi){
      setState('BRAKED'); AEC.cooldownUntil = now() + tau;
      AEC.kResumeCtr = 0;
      return true;
    } else if(AEC.state==='BRAKED'){
      // check resume conditions
      if(AEC.emaAPS <= th.lo){
        AEC.kResumeCtr++;
      } else {
        AEC.kResumeCtr = 0;
      }
      if(now()>=AEC.cooldownUntil && AEC.kResumeCtr>=K){
        setState('GENERATING'); // resume
      }
    }
    return false;
  }

  // Start/Stop/Reset

  $('startBtn').addEventListener('click', async ()=>{
    sendCfg();
    const cfg=getCfg();
    const userPrompt=$('prompt').value.trim()||'Say hello, then contradict yourself.';
    try{
      const res = await fetch(cfg.apiBase.replace(/\/$/,'')+'/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json', ...(cfg.apiKey?{'Authorization':'Bearer '+cfg.apiKey}:{})},
        body: JSON.stringify({ model: cfg.modelName||'auto', temperature:0.3, max_tokens:256, messages:[{role:'user', content:userPrompt}] })
      });
      const js = await res.json();
      const msg = js?.choices?.[0]?.message?.content || '(no content)';
      window.S = window.S || {}; window.S.fullText = (window.S.fullText||'') + '\n' + msg;
      // Tokenize
      AEC.tokens = (msg.match(/\S+\s*|\n/g) || [msg]);
      AEC.emitted = [];
      AEC.tail = [];
      AEC.tokenIdx = 0;
      setState('GENERATING');
      // Start lookahead loop
      const ctx = (window.S?.fullText || '') + ' ' + (userPrompt||'');
      scheduleLookahead(ctx);
      const th = currentThresholds();
      const {N} = tailParams();
      // streaming loop
      const step = async () => {
        if(AEC.state==='BRAKED'){ applyTailRuleDisplay(); return; }
        if(AEC.tokenIdx >= AEC.tokens.length){ applyTailRuleDisplay(); setState('IDLE'); return; }
        const tok = AEC.tokens[AEC.tokenIdx++];
        AEC.emitted.push(tok);
        AEC.tail.push(tok);
        if(AEC.tail.length > N) AEC.tail.shift(); // keep last N in tail
        // score this delta
        postWorker('TICK', { fullText: (AEC.emitted.join('')), delta: tok, anchor: userPrompt });
        applyTailRuleDisplay();
        AEC.streamTimer = setTimeout(step, 28);
      };
      step();
    }catch(e){
      $('badge').textContent='ERROR'; $('badge').className='status s-ERROR rounded-full px-3 py-1 text-sm font-semibold';
      $('output').textContent='Send failed: '+e.message;
    }
  });


  $('resetBtn').addEventListener('click', ()=>{
    if(AEC.lookTimer) clearTimeout(AEC.lookTimer);
    if(AEC.streamTimer) clearTimeout(AEC.streamTimer);
    AEC.state='IDLE'; AEC.emitted=[]; AEC.tail=[]; AEC.tokens=[]; AEC.kResumeCtr=0; AEC.stabilityStreak=0;
    chart.data.labels=[]; for(const ds of chart.data.datasets){ ds.data=[]; } chart.update();
    $('output').textContent=''; $('explanations').textContent=''; $('reasons').textContent='';
    $('badge').textContent='IDLE'; $('badge').className='status s-IDLE rounded-full px-3 py-1 text-sm font-semibold';
    postWorker('RESET',{});
  });

  // CSV Export
  $('exportCsv').addEventListener('click', ()=>{
    const rows=['idx,APS,R,C,N,S,J,P'];
    chart.data.datasets[0].data.forEach((_,i)=>{
      const vals = chart.data.datasets.map(ds=> (ds.data[i]??'')).join(',');
      rows.push(`${i},${vals}`);
    });
    const blob=new Blob([rows.join('\n')],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='sohvie_shield_metrics.csv'; a.click(); URL.revokeObjectURL(url);
  });
});
</script>

<section id="se-inline" class="panel" style="margin:16px; padding:16px; border-radius:12px; border:1px solid rgba(148,163,184,0.22); background:#111827; color:#e2e8f0;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <h3 style="margin:0; font-weight:700; font-size:16px;">Semantic Entropy (SE)</h3>
    <div style="display:flex; gap:16px; align-items:center;">
      <div>
        <div style="font-size:12px; opacity:.8;">Normalized</div>
        <div id="seKpi" style="font-size:22px; font-weight:800;">0.00</div>
      </div>
      <button id="btnTestSE" style="cursor:pointer; border:1px solid rgba(148,163,184,0.25); background:#0f172a; color:#e2e8f0; padding:8px 12px; border-radius:10px; font-size:12px;">
        Test SE
      </button>
    </div>
  </div>
  <div style="margin-top:12px; display:grid; grid-template-columns: 120px 1fr auto; gap:10px; align-items:center;">
    <label for="wSE" style="font-size:12px;">w_SE</label>
    <input id="wSE" type="range" min="0" max="1" step="0.01" value="0.45">
    <span id="seStatus" style="font-size:12px; opacity:.9;">Idle</span>
  </div>
  <div id="seExplain" style="font-size:12px; opacity:.9; margin-top:8px;"></div>
</section>

<script>
// === SE Inline Wiring (fixed to use window.worker and never silently bail) ===
(function(){
  const $ = (id)=>document.getElementById(id);
  const btn = document.getElementById('btnTestSE');
  if(!btn) return;

  function withWorker(cb){
    if(window.worker){ cb(window.worker); return; }
    // small retry loop if scripts init out of order
    let tries=0; const t = setInterval(()=>{
      tries++; if(window.worker || tries>20){ clearInterval(t); if(window.worker) cb(window.worker); }
    }, 100);
  }

  btn.addEventListener('click', ()=>{
    withWorker((worker)=>{
      const pEl = document.querySelector('#prompt, textarea[name="prompt"], textarea');
      const prompt = (pEl && pEl.value) ? pEl.value : 'Say a short sentence. Then say the opposite.';
      const ctx = (window.S && (S.fullText||'')) ? S.fullText : '';
      worker.postMessage({ type:'SE_FOR_CONTEXT', payload: { context: (ctx + ' ' + prompt).slice(-3500), K: 6, thr: 0.85 }});
      const st = document.getElementById('seStatus'); if(st) st.textContent = 'Sampling…';
    });
  });

  function blendSEIntoAPS(seVal){
    const wEl = $('wSE'); const aps = document.getElementById('apsBlend');
    if(!aps || !wEl) return;
    const w = parseFloat(wEl.value || '0.45');
    const curr = parseFloat(aps.textContent || '0') || 0;
    const blended = Math.min(1, (1-w)*curr + w*seVal);
    aps.textContent = blended.toFixed(3);
  }

  withWorker((worker)=>{
    const _oldHandler = worker.onmessage;
    worker.onmessage = (e)=>{
    // AEC hook: integrate APS into EMA/ALC

      const d = e.data || {};
      if(d.type === 'DRAFTS_SE'){
        if(d.error){
          $('seKpi').textContent = 'ERR';
          $('seStatus').textContent = d.error;
        } else {
          const se = d.payload?.se || 0;
          $('seKpi').textContent = se.toFixed(2);
          $('seStatus').textContent = 'clusters: ' + (d.payload?.m || 1);
          const ex = document.getElementById('seExplain');
          if(ex) ex.textContent = 'SE normalized in [0,1]; higher = more meaning divergence.';
          blendSEIntoAPS(se);
        }
        return;
      }
      if(typeof _oldHandler === 'function') return _oldHandler(e);
    };
  });
})();
</script>

  <!-- ===== Verification / nuXmv Panel (Merged) ===== -->
  <div class="panel p-4">
    <h2 class="text-xl font-bold mb-2">Formal Verification — nuXmv</h2>
    <p class="text-sm mb-3">This section embeds the enhanced nuXmv model (<code>AEC_nuXmv_model_v2.smv</code>) and provides a one-click download &amp; quick run commands.</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="space-y-2">
        <h3 class="font-semibold">nuXmv Model (read-only)</h3>
        <textarea id="smvModel" class="w-full h-72 font-mono text-xs p-2 border rounded" readonly>
MODULE main
CONSTANTS
  NTAIL := 5;        -- withheld tokens
  TAU   := 5;        -- cooldown ticks
  KRES  := 4;        -- consecutive LOW frames to resume
  CAD_MIN := 1;      -- min cadence
  CAD_MAX := 5;      -- max cadence
  BASE    := 3;      -- base cadence
  ALPHA   := 1;      -- APS influence on cadence
  BETA    := 1;      -- velocity influence on cadence
  GAMMA   := 1;      -- stability streak influence on cadence
;

VAR
  -- Finite automaton states
  state : {IDLE, GENERATING, ANALYZING, BRAKED, RESUME};

  -- APS bucket and numeric proxy
  aps   : {LOW, MID, HIGH, CRIT};
  aps_num : 0..3;          -- LOW=0, MID=1, HIGH=2, CRIT=3
  aps_prev : 0..3;         -- previous aps_num
  vel      : -3..3;        -- velocity = aps_num - aps_prev
  stable_streak : 0..10;   -- increments when aps=LOW, resets when aps&gt;=HIGH

  -- Environment inputs (nondeterministic)
  start : boolean;         -- prompt event
  look  : boolean;         -- trigger lookahead
  gen   : boolean;         -- attempt to generate a token this step

  -- Cooldown &amp; resume counters
  cooldown : 0..TAU;
  kframes  : 0..KRES;

  -- Cadence (explicit) and previous cadence for monotonic checks
  c      : CAD_MIN..CAD_MAX;
  c_prev : CAD_MIN..CAD_MAX;

  -- Tail queue (concrete, but abstract content): counts only
  tail_count        : 0..NTAIL;  -- withheld tokens
  risky_tail_count  : 0..NTAIL;  -- how many withheld tokens were generated under HIGH/CRIT

  -- Outputs / derived
  emit     : boolean;
  violation: boolean;

ASSIGN
  init(state) := IDLE;
  init(aps) := LOW;
  init(aps_num) := 0;
  init(aps_prev) := 0;
  init(vel) := 0;
  init(stable_streak) := 0;
  init(cooldown) := 0;
  init(kframes) := 0;
  init(c) := BASE;         -- start in base, will be clipped
  init(c_prev) := BASE;
  init(tail_count) := 0;
  init(risky_tail_count) := 0;
  init(emit) := FALSE;
  init(violation) := FALSE;

  -- Environment choices each step
  next(aps) := {LOW, MID, HIGH, CRIT};
  next(start) := {TRUE, FALSE};
  next(look)  := {TRUE, FALSE};
  next(gen)   := {TRUE, FALSE};

  -- Map aps to numeric bucket
  next(aps_num) := case
    next(aps) = LOW  : 0;
    next(aps) = MID  : 1;
    next(aps) = HIGH : 2;
    TRUE             : 3; -- CRIT
  esac;

  -- Track previous APS and velocity
  next(aps_prev) := aps_num;
  next(vel) := next(aps_num) - aps_num;

  -- Stability streak: increment when APS LOW, reset when APS &gt;= HIGH; hold otherwise
  next(stable_streak) := case
    next(aps) = LOW                      : (stable_streak &lt; 10) ? stable_streak + 1 : 10;
    (next(aps) = HIGH | next(aps) = CRIT): 0;
    TRUE                                 : stable_streak;
  esac;

  -- State transitions (with immediate braking on HIGH/CRIT)
  next(state) := case
    (next(aps) = HIGH | next(aps) = CRIT) : BRAKED;

    state = IDLE &amp; start     : GENERATING;
    state = IDLE &amp; !start    : IDLE;

    state = GENERATING &amp; look : ANALYZING;
    state = GENERATING &amp; !look: GENERATING;

    state = ANALYZING &amp; (next(aps) = LOW | next(aps) = MID) : GENERATING;
    state = ANALYZING &amp; !(next(aps) = LOW | next(aps) = MID) : BRAKED;

    state = BRAKED &amp; (cooldown = TAU) &amp; (kframes = KRES) &amp; (next(aps) = LOW) : RESUME;
    state = BRAKED : BRAKED;

    state = RESUME : GENERATING;

    TRUE : state;
  esac;

  -- Cooldown counter (only while BRAKED)
  next(cooldown) := case
    state != BRAKED &amp; next(state) = BRAKED : 0;             -- entered BRAKED
    next(state) = BRAKED &amp; cooldown &lt; TAU  : cooldown + 1;  -- count up
    next(state) = BRAKED &amp; cooldown = TAU  : cooldown;      -- hold
    next(state) != BRAKED                  : 0;             -- reset on leave
    TRUE : cooldown;
  esac;

  -- K_RESUME consecutive LOW frames while BRAKED
  next(kframes) := case
    next(state) = BRAKED &amp; next(aps) = LOW &amp; kframes &lt; KRES : kframes + 1;
    next(state) = BRAKED &amp; next(aps) != LOW                 : 0;
    next(state) != BRAKED                                    : 0;
    TRUE : kframes;
  esac;

  -- Cadence update (clipped linear law): c&#x27; = clip(BASE - ALPHA*aps_num - BETA*vel + GAMMA*stable_streak)
  next(c_prev) := c;
  next(c) :=
    case
      TRUE :
        let raw := BASE - ALPHA*next(aps_num) - BETA*next(vel) + GAMMA*next(stable_streak) in
          (raw &lt; CAD_MIN) ? CAD_MIN :
          (raw &gt; CAD_MAX) ? CAD_MAX : raw;
    esac;

  -- Tail queue management
  -- On entering BRAKED: discard tail entirely (non-leakage policy)
  next(tail_count) := case
    state != BRAKED &amp; next(state) = BRAKED : 0;
    -- Generate: enqueue withheld token up to NTAIL
    gen &amp; tail_count &lt; NTAIL               : tail_count + 1;
    gen &amp; tail_count &gt;= NTAIL              : tail_count;
    -- Safe emission: only when not BRAKED, APS LOW, and no risky tokens remain
    next(state) != BRAKED &amp; next(aps) = LOW &amp; risky_tail_count = 0 &amp; tail_count &gt; 0 : tail_count - 1;
    TRUE : tail_count;
  esac;

  next(risky_tail_count) := case
    state != BRAKED &amp; next(state) = BRAKED : 0;  -- discard risky tokens on brake
    -- Generate under high risk: mark in risky count (bounded by tail capacity)
    gen &amp; (next(aps) = HIGH | next(aps) = CRIT) &amp; risky_tail_count &lt; NTAIL : risky_tail_count + 1;
    -- Safe emission only allowed when risky_tail_count = 0; thus no decrement here
    TRUE : risky_tail_count;
  esac;

  -- Emission and violation flags
  next(emit) := next(state) != BRAKED &amp; next(aps) = LOW &amp; risky_tail_count = 0 &amp; tail_count &gt; 0;
  -- Violation if an emission occurs while any risky token remains (should never happen)
  next(violation) := next(emit) &amp; (risky_tail_count &gt; 0);

-- =====================
--  PROPERTIES TO CHECK
-- =====================

-- 1) Non-leakage: never emit while a risky token exists
INVARSPEC G !(emit &amp; (risky_tail_count &gt; 0))

-- 2) Immediate brake on HIGH/CRIT
LTLSPEC G( (aps = HIGH | aps = CRIT) -&gt; X state = BRAKED )

-- 3) Eventual resume after cooldown + KRES LOW frames
LTLSPEC G( (state = BRAKED &amp; cooldown = TAU &amp; kframes = KRES &amp; aps = LOW) -&gt; F state = RESUME )

-- 4) No oscillation before ready: remain BRAKED until conditions met
LTLSPEC G( (state = BRAKED &amp; !(cooldown = TAU &amp; kframes = KRES &amp; aps = LOW)) -&gt; X state = BRAKED )

-- 5) Cadence bounds must always hold
INVARSPEC G (c &gt;= CAD_MIN &amp; c &lt;= CAD_MAX)

-- 6) Cadence responsiveness: if APS increases (num), cadence should not increase next step
--    i.e., aps_num&#x27; &gt; aps_num  =&gt;  c&#x27; &lt;= c
LTLSPEC G( (aps_num &lt; next(aps_num)) -&gt; X (c &lt;= c_prev) )

-- 7) Cadence responsiveness: if APS decreases and we are stably LOW, cadence should not decrease
LTLSPEC G( (aps_num &gt; next(aps_num) &amp; next(aps) = LOW &amp; stable_streak &gt;= 1) -&gt; X (c &gt;= c_prev) )
</textarea>
        <div class="flex gap-2">
          <button id="downloadSMV" class="btn">Download .smv</button>
          <button id="copyCommands" class="btn">Copy run commands</button>
        </div>
        <pre id="commands" class="mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto">nuXmv AEC_nuXmv_model_v2.smv
go
check_invar
check_ltlspec
simulate -k 25 -r</pre>
      </div>
      <div class="space-y-2">
        <h3 class="font-semibold">Automaton Diagram</h3>
        <p class='text-sm'>
<!-- Animated AEC Governor Automaton (pure CSS) -->
<style>
  .aec-automaton { max-width: 720px; width: 100%; height: auto; display:block; margin: 0 auto; }
  .node circle { fill: none; stroke: #64748b; stroke-width: 2; }
  .node text   { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; font-size: 13px; fill: #e5e7eb; }
  .edge path   { stroke: #94a3b8; stroke-width: 1.5; fill: none; marker-end: url(#arrow); opacity: .85; }

  /* Highlight animation */
  @keyframes aec-pulse {
    0% { stroke: #22c55e; stroke-width: 3; filter: drop-shadow(0 0 0 rgba(34,197,94,0)); }
    50% { stroke: #22c55e; stroke-width: 5; filter: drop-shadow(0 0 6px rgba(34,197,94,.6)); }
    100% { stroke: #22c55e; stroke-width: 3; filter: drop-shadow(0 0 0 rgba(34,197,94,0)); }
  }
  /* Sequence timing */
  .IDLE.highlight circle        { animation: aec-pulse 1.2s ease-in-out 0s    1 forwards; }
  .GENERATING.highlight circle  { animation: aec-pulse 1.2s ease-in-out 1.0s  1 forwards; }
  .ANALYZING.highlight circle   { animation: aec-pulse 1.2s ease-in-out 2.0s  1 forwards; }
  .BRAKED.highlight circle      { animation: aec-pulse 1.2s ease-in-out 3.0s  1 forwards; }
  .DONE.highlight circle        { animation: aec-pulse 1.2s ease-in-out 4.0s  1 forwards; }

  /* Loop the sequence subtly by repeating after a rest */
  .loop .IDLE.highlight circle,
  .loop .GENERATING.highlight circle,
  .loop .ANALYZING.highlight circle,
  .loop .BRAKED.highlight circle,
  .loop .DONE.highlight circle { animation-iteration-count: infinite; animation-direction: normal; }

  /* Edge emphasis during sequence (optional subtle opacity bumps) */
  @keyframes edge-glow {
    0% { opacity: .85; }
    50% { opacity: 1; }
    100% { opacity: .85; }
  }
  .edge.idle-gen  { animation: edge-glow 1.2s ease-in-out 0.5s  infinite; }
  .edge.gen-ana   { animation: edge-glow 1.2s ease-in-out 1.5s  infinite; }
  .edge.ana-gen   { animation: edge-glow 1.2s ease-in-out 2.5s  infinite; }
  .edge.gen-brk   { animation: edge-glow 1.2s ease-in-out 3.0s  infinite; }
  .edge.ana-brk   { animation: edge-glow 1.2s ease-in-out 3.0s  infinite; }
  .edge.brk-done  { animation: edge-glow 1.2s ease-in-out 4.0s  infinite; }
</style>

<svg class="aec-automaton loop" viewBox="0 0 1000 520" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="AEC Governor Automaton">
  <defs>
    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8"></path>
    </marker>
  </defs>

  <!-- Nodes -->
  <g class="node IDLE highlight">
    <circle cx="120" cy="260" r="55"></circle>
    <text x="120" y="265" text-anchor="middle">IDLE</text>
  </g>

  <g class="node GENERATING highlight">
    <circle cx="380" cy="120" r="55"></circle>
    <text x="380" y="125" text-anchor="middle">GENERATING</text>
  </g>

  <g class="node ANALYZING highlight">
    <circle cx="380" cy="400" r="55"></circle>
    <text x="380" y="405" text-anchor="middle">ANALYZING</text>
  </g>

  <g class="node BRAKED highlight">
    <circle cx="670" cy="260" r="55"></circle>
    <text x="670" y="265" text-anchor="middle">BRAKED</text>
  </g>

  <g class="node DONE highlight">
    <circle cx="910" cy="260" r="55"></circle>
    <text x="910" y="265" text-anchor="middle">DONE</text>
  </g>

  <!-- Edges -->
  <g class="edge idle-gen"><path d="M 175 240 C 240 210, 300 170, 335 145" /></g>
  <g class="edge gen-ana"><path d="M 380 175 C 380 230, 380 300, 380 345" /></g>
  <g class="edge ana-gen"><path d="M 380 345 C 380 300, 380 230, 380 175" /></g>
  <g class="edge gen-brk"><path d="M 430 135 C 520 170, 595 215, 615 235" /></g>
  <g class="edge ana-brk"><path d="M 430 385 C 520 350, 595 305, 615 285" /></g>
  <g class="edge brk-done"><path d="M 725 260 C 780 260, 845 260, 885 260" /></g>

  <!-- Legend -->
  <g class="legend">
    <text x="20" y="30" fill="#9ca3af" font-size="14" font-family="system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif">
      Sequence: IDLE → GENERATING → ANALYZING → BRAKED → DONE (looping)
    </text>
  </g>
</svg>
.</p>
        <p class="text-xs text-gray-600">States: IDLE → GENERATING → ANALYZING → BRAKED → RESUME. Guards: APS thresholds, cooldown τ, K_RESUME, tail-buffer non-leakage, cadence bounds.</p>
      </div>
    </div>
  </div>

  <script>
    (function() { 
      var smv = (document.getElementById('smvModel') && document.getElementById('smvModel').value) || '';
      var dl = document.getElementById('downloadSMV');
      var cc = document.getElementById('copyCommands');
      if (dl) dl.addEventListener('click', function(){ 
        var blob = new Blob([smv], {type:'text/plain'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'AEC_nuXmv_model_v2.smv';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      if (cc) cc.addEventListener('click', async function(){
        var cmds = document.getElementById('commands').innerText;
        try { await navigator.clipboard.writeText(cmds); cc.textContent='Copied!'; setTimeout(function(){cc.textContent='Copy run commands';}, 1500); }
        catch(e) { alert('Copy failed: '+e.message); }
      });
    })();
  </script>


<div class="panel p-3 m-4"><div class="text-sm text-slate-400 mb-2">AEC Governor Automaton</div><img src="aec_automaton_working.png" alt="AEC Governor Automaton" class="max-w-full h-auto mx-auto"></div>
<script>
setInterval(()=>{
  const el = document.getElementById('lookHealth');
  if(!el) return;
  const t = window.__lastLookTs;
  if(!t){ el.textContent = 'Lookahead: waiting…'; return; }
  const ms = Math.max(0, Date.now()-t);
  const s = (ms/1000).toFixed(1);
  if(!/\|\sage:/.test(el.textContent)) el.textContent += ' | age: '+s+'s';
  else el.textContent = el.textContent.replace(/\|\sage:[^|]+/, '| age: '+s+'s');
}, 800);
</script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // Toggle debug visibility
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='toggleBlendDebug'){
      const box = $('blendDebug');
      if(!box) return;
      box.classList.toggle('hidden');
      e.target.textContent = box.classList.contains('hidden') ? 'Show blend debug' : 'Hide blend debug';
    }
  });

  // Push CONFIG updates to worker when K or thr change
  function pushSEConfig(){
    const K = parseInt($('seKDrafts')?.value || '6', 10);
    const thr = parseFloat($('seClusterThr')?.value || '0.85');
    if(window.postWorker){
      try{ postWorker('CONFIG', { K, thr }); }catch(e){}
    }
  }
  ['seKDrafts','seClusterThr'].forEach(id=>{
    const el=$(id);
    if(el){ el.addEventListener('input', pushSEConfig); el.addEventListener('change', pushSEConfig); }
  });
  // Initial push when ready
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', pushSEConfig); } else { pushSEConfig(); }

  // Helper to compute blend terms for debug (mirrors blendAPS without side effects)
  function computeBlendTerms(w){
    const wA = parseFloat($('wA')?.value || '0.6');
    const wV = parseFloat($('wV')?.value || '0.25');
    const wF = parseFloat($('wF')?.value || '0.15');
    const wSE = parseFloat($('wSE')?.value || '0.20');
    const se = (w.SE!=null ? w.SE : (window.S && typeof S.se==='number' ? S.se : 0));
    const sum = Math.max(0, Math.min(1, wA*(w.R||0) + wV*(w.N||0) + wF*(w.C||0) + wSE*se));
    const base = Math.max(sum, w.S||0, w.J||0, w.P||0);
    return {R:w.R||0,N:w.N||0,C:w.C||0,SE:se,S:w.S||0,J:w.J||0,P:w.P||0,sum,APS:base};
  }

  // Patch worker.onmessage dynamically to add debug + logprobs pill updates while preserving existing behavior
  const _origOnMsg = window.worker && window.worker.onmessage;
  if(_origOnMsg){
    window.worker.onmessage = (e)=>{
      try{
        const d=e.data||{};
        if(d && d.type==='DRAFT_METRICS'){
          const has = !!d.payload?.hasLogprobs || (typeof d.payload?.ent === 'number');
          const pill = $('logprobPill');
          if(pill){
            pill.textContent = 'logprobs: ' + (has ? 'yes' : 'no');
            pill.style.background = has ? '#065f46' : '#92400e';
          }
        }
        // Fall through to original handler
        _origOnMsg.call(window.worker, e);
        // After original handler, if this tick included R/N/C/etc., update debug
        const wKeys = ['R','N','C','S','J','P'];
        if(wKeys.some(k => k in d)){
          const terms = computeBlendTerms({R:d.R||0,N:d.N||0,C:d.C||0,S:d.S||0,J:d.J||0,P:d.P||0});
          const box = $('blendDebug');
          if(box && !box.classList.contains('hidden')){
            box.textContent = `R=${terms.R.toFixed(3)}  N=${terms.N.toFixed(3)}  C=${terms.C.toFixed(3)}  SE=${terms.SE.toFixed(3)}  S=${terms.S.toFixed(3)}  J=${terms.J.toFixed(3)}  P=${terms.P.toFixed(3)}  sum=${terms.sum.toFixed(3)}  APS=${terms.APS.toFixed(3)}`;
          }
        }
      }catch(err){ console.error(err); }
    };
  }
})();
</script>
</body>
</html>
